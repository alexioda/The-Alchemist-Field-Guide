<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Alchemist's Field Guide | Protocol Manual</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400;1,600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Cormorant Garamond"', 'serif'],
                        sans: ['"Inter"', 'sans-serif'],
                    },
                    colors: {
                        stone: { 50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1', 400: '#a8a29e', 500: '#78716c', 600: '#57534e', 700: '#44403c', 800: '#292524', 900: '#1c1917' },
                        gold: { 50: '#fffbeb', 100: '#fef3c7', 200: '#fde68a', 300: '#fcd34d', 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706', 700: '#b45309', 800: '#92400e', 900: '#78350f' }
                    }
                }
            }
        }
    </script>

    <style>
        .chart-container { position: relative; width: 100%; max-width: 600px; margin: 0 auto; height: 250px; }
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .journal-input { background-image: linear-gradient(transparent, transparent 31px, #e7e5e4 31px, #e7e5e4 32px, transparent 32px); background-size: 100% 32px; line-height: 32px; padding: 8px 0; }
        .accordion-content { transition: max-height 0.3s ease-out, opacity 0.3s ease-out; max-height: 0; opacity: 0; overflow: hidden; }
        .accordion-open { max-height: 500px; opacity: 1; }
        
        /* Audio Wave Animation */
        .loading-wave { display: inline-flex; gap: 3px; align-items: center; height: 12px; }
        .loading-wave div { width: 3px; background: #fbbf24; animation: wave 1s infinite ease-in-out; border-radius: 10px; }
        .loading-wave div:nth-child(2) { animation-delay: 0.1s; }
        .loading-wave div:nth-child(3) { animation-delay: 0.2s; }
        .loading-wave div:nth-child(4) { animation-delay: 0.3s; }
        @keyframes wave { 0%, 100% { height: 4px; opacity: 0.5; } 50% { height: 16px; opacity: 1; } }
    </style>
</head>
<body class="bg-stone-50 text-stone-900 font-sans antialiased h-screen overflow-hidden flex flex-col md:flex-row">

    <!-- ================== START GATING SYSTEM (THE LOCK) ================== -->
    <!-- This covers the entire screen until unlocked -->
    <div id="access-gate" class="fixed inset-0 z-[100] bg-stone-950 flex flex-col items-center justify-center text-center px-6 transition-opacity duration-700">
        <div class="max-w-sm w-full">
            <div class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-8 text-gold-400 border border-white/10">
                <i data-lucide="lock" class="w-6 h-6"></i>
            </div>
            
            <h1 class="font-serif text-4xl text-white italic mb-3">Restricted Access</h1>
            <p class="text-xs text-white/40 uppercase tracking-[0.2em] mb-10">Enter Protocol Cipher</p>
            
            <input type="password" id="gate-pass" placeholder="Enter Access Code" 
                class="w-full bg-white/5 border border-white/10 rounded-xl py-4 px-4 text-center text-white text-lg tracking-widest focus:outline-none focus:border-gold-500/50 transition-all mb-4 placeholder:text-white/10 font-serif">
            
            <button onclick="unlockGate()" 
                class="w-full py-4 bg-white text-stone-900 font-bold text-xs uppercase tracking-widest rounded-xl hover:bg-gold-400 transition-all">
                Unlock Field Guide
            </button>
            
            <p id="gate-error" class="text-red-400 text-xs mt-4 hidden uppercase tracking-widest animate-pulse">Incorrect Cipher</p>
            
            <div class="mt-12 pt-8 border-t border-white/5">
                <p class="text-stone-500 text-[10px] mb-2 uppercase tracking-widest">Need Access?</p>
                <!-- Link to your Gumroad purchase page -->
                <a href="https://alexioda.gumroad.com/l/roxaxf" target="_blank" class="text-gold-400 text-[10px] uppercase tracking-widest hover:text-white transition-colors border-b border-gold-400/30 pb-1">Get the Cipher Code</a>
            </div>
        </div>
    </div>
    <!-- ================== END GATING SYSTEM ================== -->

    <!-- Mobile Header -->
    <div class="md:hidden bg-stone-900 text-stone-50 p-4 flex justify-between items-center z-50 shadow-md">
        <span class="font-serif text-xl italic">Adaptiv Field Guide</span>
        <button id="mobile-menu-btn" class="text-gold-400 text-2xl leading-none">‚ò∞</button>
    </div>

    <!-- Mobile Menu Overlay -->
    <div id="mobile-menu" class="fixed inset-0 bg-stone-900/95 z-40 hidden flex-col justify-center items-center space-y-6 backdrop-blur-sm"></div>

    <!-- Sidebar -->
    <aside class="hidden md:flex flex-col w-80 bg-stone-900 text-stone-300 h-full border-r border-stone-800 p-8 overflow-y-auto no-scrollbar flex-shrink-0">
        <div class="mb-12">
            <h1 class="font-serif text-4xl text-stone-50 italic leading-none mb-2">The<br>Alchemist's<br>Guide</h1>
            <div class="h-1 w-12 bg-gold-500 mb-4"></div>
            <p class="text-[10px] uppercase tracking-[0.2em] text-stone-500">Manual of Operations</p>
        </div>

        <nav class="space-y-1 flex-1" id="desktop-nav"></nav>

        <div class="mt-8 pt-8 border-t border-stone-800">
            <div class="flex items-center gap-3 opacity-60">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-[10px] uppercase tracking-widest">Protocol Active</span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 h-full overflow-y-auto relative bg-stone-50" id="main-content">
        <div class="max-w-3xl mx-auto px-6 py-12 md:py-20 min-h-full flex flex-col pb-32">
            <div id="content-container" class="flex-1 fade-in"></div>

            <div class="mt-20 flex justify-between items-center border-t border-stone-200 pt-8 pb-8" id="footer-nav">
                <button id="prev-btn" class="text-stone-400 hover:text-stone-900 font-serif italic text-lg transition-colors flex items-center gap-2 disabled:opacity-0 cursor-pointer">&larr; Previous</button>
                <div class="h-1 flex-1 mx-4 bg-stone-200 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-gold-500 w-0 transition-all duration-500 shadow-[0_0_10px_rgba(245,158,11,0.5)]"></div>
                </div>
                <button id="next-btn" class="bg-stone-900 text-stone-50 px-8 py-3 rounded-full hover:bg-gold-600 hover:text-stone-900 transition-all font-sans text-xs font-bold tracking-[0.2em] uppercase shadow-lg transform hover:-translate-y-0.5">Next &rarr;</button>
            </div>
        </div>
    </main>

    <!-- Audio Player (Sticky Footer) -->
    <div id="audio-player-bar" class="fixed bottom-0 md:bottom-6 md:left-auto md:right-6 md:w-96 w-full glass-panel md:rounded-2xl p-4 transform translate-y-[150%] transition-transform duration-500 z-[60] flex items-center justify-between border-t md:border border-gold-500/20 bg-stone-900/95 backdrop-blur-xl shadow-2xl">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-gold-500/10 rounded-full flex items-center justify-center text-gold-400">
                 <div class="loading-wave hidden" id="player-wave"><div></div><div></div><div></div><div></div></div>
                 <i data-lucide="play" id="player-icon" class="w-4 h-4 fill-current"></i>
            </div>
            <div>
                <p class="font-serif text-sm text-stone-200 italic" id="player-title">Coach's Guide</p>
                <p class="text-[9px] text-stone-500 uppercase tracking-widest" id="player-status">Ready</p>
            </div>
        </div>
        <button onclick="stopAudio()" class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center text-stone-400 hover:text-white transition-colors">
            <i data-lucide="x" class="w-4 h-4"></i>
        </button>
    </div>

    <script>
        // --- GATING LOGIC ---
        const ACCESS_CODE = "GENESIS2026"; // The password
        const PRODUCT_ID = "alchemist_guide_v1"; 

        function initGate() {
            const gate = document.getElementById('access-gate');
            // If already unlocked in this browser, hide gate immediately
            if (localStorage.getItem(PRODUCT_ID) === 'unlocked') {
                gate.style.display = 'none';
            }
        }

        function unlockGate() {
            const input = document.getElementById('gate-pass');
            const gate = document.getElementById('access-gate');
            
            if (input.value === ACCESS_CODE) {
                localStorage.setItem(PRODUCT_ID, 'unlocked');
                gate.style.opacity = '0';
                setTimeout(() => gate.style.display = 'none', 700);
            } else {
                document.getElementById('gate-error').classList.remove('hidden');
                input.value = '';
                input.focus();
            }
        }

        // --- DATA & STATE ---
        const appState = {
            currentStep: 0,
            entries: {
                cycle1: { before: 5, after: 8, insight: "" },
                cycle2: { sensation: "", message: "" },
                cycle3: { thought: "", reframe: "" },
                cycle4: { question: "", answer: "" },
                cycle5: { stillness: "" },
                cycle6: { action: "", commitment: "" },
                cycle7: { identity: "" }
            }
        };

        const contentMap = [
            {
                id: 'intro',
                title: "Protocol Overview",
                icon: "‚óâ",
                audioText: "Welcome to the Alchemist's Field Guide. This is not a book to be read; it is a protocol to be executed. For the next 7 cycles, you will learn to transmute stress into fuel. Do not rush. Let's begin.",
                render: () => `
                    <div class="text-center space-y-8">
                        <span class="text-xs font-bold tracking-[0.3em] uppercase text-gold-600 border border-gold-200 px-3 py-1 rounded-full">The Architecture</span>
                        <h2 class="text-4xl md:text-6xl font-serif italic text-stone-900 leading-none">The Seven<br>Cycles.</h2>
                        <div class="w-16 h-1 bg-gold-400 mx-auto"></div>
                        
                        <div class="flex justify-center mt-6">
                            <button onclick="playSectionAudio()" class="flex items-center gap-3 px-6 py-2 bg-stone-900 text-white rounded-full text-xs font-bold uppercase tracking-widest hover:bg-gold-600 hover:text-stone-900 transition-all">
                                <i data-lucide="play" class="w-4 h-4"></i> Listen to Overview
                            </button>
                        </div>

                        <p class="text-lg text-stone-600 font-serif leading-relaxed max-w-xl mx-auto">
                            You are not here to "fix" yourself. You are here to learn the mechanics of your own energy.
                        </p>
                        
                        <div class="grid md:grid-cols-3 gap-4 text-left mt-12">
                            <div class="p-6 bg-white border border-stone-200 rounded-xl shadow-sm">
                                <div class="text-2xl mb-2">‚ö°</div>
                                <h3 class="font-bold text-xs uppercase tracking-widest mb-2">The Biometrics</h3>
                                <p class="text-sm text-stone-500">We do not assume stress. We measure it. Every cycle begins with a scan.</p>
                            </div>
                            <div class="p-6 bg-white border border-stone-200 rounded-xl shadow-sm">
                                <div class="text-2xl mb-2">‚öñÔ∏è</div>
                                <h3 class="font-bold text-xs uppercase tracking-widest mb-2">The Fork</h3>
                                <p class="text-sm text-stone-500">Stress hits the <strong>Body</strong> (Weight) or the <strong>Mind</strong> (Noise). You will learn to treat them differently.</p>
                            </div>
                            <div class="p-6 bg-white border border-stone-200 rounded-xl shadow-sm">
                                <div class="text-2xl mb-2">üî•</div>
                                <h3 class="font-bold text-xs uppercase tracking-widest mb-2">The Alchemy</h3>
                                <p class="text-sm text-stone-500">We do not calm down. We transform friction into fuel for action.</p>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                id: 'cycle1',
                title: "Cycle 01: Initiation",
                icon: "01",
                audioText: "Cycle 1. Initiation. The first step in alchemy is locating the material. Today, simply run the app to establish a baseline. When we measure stress, we stop being the stress.",
                render: () => `
                    <div class="space-y-8">
                        <div class="flex justify-between items-end border-b border-stone-300 pb-4">
                            <div>
                                <h2 class="text-5xl font-serif italic text-stone-900">Initiation</h2>
                                <span class="text-xs font-bold uppercase tracking-widest text-gold-600 mb-2">Cycle 01</span>
                            </div>
                            <button onclick="playSectionAudio()" class="p-3 bg-stone-100 rounded-full hover:bg-gold-400 transition-colors"><i data-lucide="headphones" class="w-5 h-5 text-stone-700"></i></button>
                        </div>
                        
                        <p class="font-serif text-xl text-stone-700 leading-relaxed">
                            The first step in alchemy is simply locating the material. Today, run the app without overthinking. Your only goal is to establish a baseline.
                        </p>

                        <div class="bg-white p-8 rounded-2xl shadow-lg border border-stone-100">
                            <h3 class="font-sans text-xs font-bold uppercase tracking-widest mb-8 text-stone-400">The Shift Metric</h3>
                            <div class="grid grid-cols-2 gap-8 mb-8">
                                <div>
                                    <label class="block text-xs uppercase tracking-widest text-stone-500 mb-2">Entry State</label>
                                    <input type="range" min="1" max="10" value="${appState.entries.cycle1.before}" oninput="updateCycle1(this.value, 'before')" class="w-full accent-stone-900">
                                    <div class="text-3xl font-serif italic text-stone-900 mt-2" id="val-before">${appState.entries.cycle1.before}</div>
                                </div>
                                <div>
                                    <label class="block text-xs uppercase tracking-widest text-stone-500 mb-2">Exit State</label>
                                    <input type="range" min="1" max="10" value="${appState.entries.cycle1.after}" oninput="updateCycle1(this.value, 'after')" class="w-full accent-gold-500">
                                    <div class="text-3xl font-serif italic text-gold-600 mt-2" id="val-after">${appState.entries.cycle1.after}</div>
                                </div>
                            </div>
                            <div class="chart-container"><canvas id="c1Chart"></canvas></div>
                        </div>
                    </div>
                `
            },
            {
                id: 'cycle2',
                title: "Cycle 02: Somatic Map",
                icon: "02",
                audioText: "Cycle 2. The Somatic Map. Emotions are biological events. When you reach the Vessel screen, do not rush. Close your eyes. Where does the tension live? Name it to tame it.",
                render: () => `
                    <div class="space-y-8">
                        <div class="flex justify-between items-end border-b border-stone-300 pb-4">
                            <div>
                                <h2 class="text-5xl font-serif italic text-stone-900">The Body</h2>
                                <span class="text-xs font-bold uppercase tracking-widest text-gold-600 mb-2">Cycle 02</span>
                            </div>
                            <button onclick="playSectionAudio()" class="p-3 bg-stone-100 rounded-full hover:bg-gold-400 transition-colors"><i data-lucide="headphones" class="w-5 h-5 text-stone-700"></i></button>
                        </div>
                        <div class="bg-stone-100 p-6 rounded-lg border-l-4 border-stone-900">
                            <p class="font-sans text-xs font-bold uppercase tracking-widest text-stone-500 mb-2">Protocol Instruction</p>
                            <p class="font-serif text-lg">At the Source screen, choose <strong>"The Body"</strong>. Allow yourself to identify where the weight lives physically.</p>
                        </div>
                        <div class="space-y-6 pt-4">
                            <div>
                                <label class="font-serif text-xl text-stone-800 block mb-2">Describe the texture of the sensation (color, temperature, weight).</label>
                                <textarea oninput="saveEntry('cycle2', 'sensation', this.value)" class="w-full bg-transparent border-b border-stone-300 focus:border-stone-900 focus:outline-none min-h-[80px] journal-input resize-none text-stone-700 font-serif text-lg">${appState.entries.cycle2.sensation}</textarea>
                            </div>
                            <div>
                                <label class="font-serif text-xl text-stone-800 block mb-2">If this part had a voice, what is its one-sentence warning?</label>
                                <textarea oninput="saveEntry('cycle2', 'message', this.value)" class="w-full bg-transparent border-b border-stone-300 focus:border-stone-900 focus:outline-none min-h-[80px] journal-input resize-none text-stone-700 font-serif text-lg">${appState.entries.cycle2.message}</textarea>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                id: 'cycle3',
                title: "Cycle 03: The Filter",
                icon: "03",
                audioText: "Cycle 3. The Filter. We are hunting for loops. Your brain is trying to protect you by predicting disaster. Catch the loop, and write down the absolute fact.",
                render: () => `
                    <div class="space-y-8">
                         <div class="flex justify-between items-end border-b border-stone-300 pb-4">
                            <div>
                                <h2 class="text-5xl font-serif italic text-stone-900">The Mind</h2>
                                <span class="text-xs font-bold uppercase tracking-widest text-gold-600 mb-2">Cycle 03</span>
                            </div>
                            <button onclick="playSectionAudio()" class="p-3 bg-stone-100 rounded-full hover:bg-gold-400 transition-colors"><i data-lucide="headphones" class="w-5 h-5 text-stone-700"></i></button>
                        </div>
                        <div class="grid md:grid-cols-2 gap-8">
                            <div class="p-6 border border-stone-200 rounded-xl">
                                <label class="font-sans text-xs font-bold uppercase tracking-widest text-stone-400 block">The Loop</label>
                                <textarea oninput="saveEntry('cycle3', 'thought', this.value)" class="w-full bg-transparent border-b border-stone-200 focus:border-stone-900 outline-none h-32 resize-none text-stone-600 font-serif text-lg italic mt-2" placeholder="I keep thinking that...">${appState.entries.cycle3.thought}</textarea>
                            </div>
                            <div class="p-6 bg-stone-900 rounded-xl text-stone-300">
                                <label class="font-sans text-xs font-bold uppercase tracking-widest text-gold-500 block">The Fact</label>
                                <textarea oninput="saveEntry('cycle3', 'reframe', this.value)" class="w-full bg-transparent border-b border-stone-700 focus:border-gold-500 outline-none h-32 resize-none text-white font-serif text-lg mt-2" placeholder="The absolute truth is...">${appState.entries.cycle3.reframe}</textarea>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                id: 'cycle4',
                title: "Cycle 04: The Pivot",
                icon: "04",
                audioText: "Cycle 4. The Pivot. The Laser Coaching module will ask you a question. One of them will sting. That is the one you need to answer honestly.",
                render: () => `
                    <div class="space-y-8">
                         <div class="flex justify-between items-end border-b border-stone-300 pb-4">
                            <div>
                                <h2 class="text-5xl font-serif italic text-stone-900">The Pivot</h2>
                                <span class="text-xs font-bold uppercase tracking-widest text-gold-600 mb-2">Cycle 04</span>
                            </div>
                            <button onclick="playSectionAudio()" class="p-3 bg-stone-100 rounded-full hover:bg-gold-400 transition-colors"><i data-lucide="headphones" class="w-5 h-5 text-stone-700"></i></button>
                        </div>
                        <div class="space-y-6 pt-4">
                            <div>
                                <label class="font-serif text-xl text-stone-800 block mb-2">Write down the question the AI asked that stopped you in your tracks:</label>
                                <div class="p-4 bg-stone-100 rounded-lg italic text-stone-600">
                                    "<input type="text" oninput="saveEntry('cycle4', 'question', this.value)" value="${appState.entries.cycle4.question}" class="bg-transparent w-full outline-none" placeholder="...">"
                                </div>
                            </div>
                            <div>
                                <label class="font-serif text-xl text-stone-800 block mb-2">Your honest answer:</label>
                                <textarea oninput="saveEntry('cycle4', 'answer', this.value)" class="w-full bg-transparent border-b border-stone-300 focus:border-stone-900 focus:outline-none min-h-[80px] journal-input resize-none text-stone-700 font-serif text-lg">${appState.entries.cycle4.answer}</textarea>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                id: 'cycle5',
                title: "Cycle 05: The Void",
                icon: "05",
                audioText: "Cycle 5. The Void. When you reach the Regulation circle, do not skip. Wait for the ripple. Stay for three extra breaths. Silence is where the insight lives.",
                render: () => `
                    <div class="space-y-8">
                         <div class="flex justify-between items-end border-b border-stone-300 pb-4">
                            <div>
                                <h2 class="text-5xl font-serif italic text-stone-900">The Void</h2>
                                <span class="text-xs font-bold uppercase tracking-widest text-gold-600 mb-2">Cycle 05</span>
                            </div>
                            <button onclick="playSectionAudio()" class="p-3 bg-stone-100 rounded-full hover:bg-gold-400 transition-colors"><i data-lucide="headphones" class="w-5 h-5 text-stone-700"></i></button>
                        </div>
                        <div class="flex justify-center py-8">
                            <div class="w-32 h-32 rounded-full border-2 border-stone-200 flex items-center justify-center animate-pulse">
                                <div class="w-24 h-24 rounded-full bg-stone-100 flex items-center justify-center">
                                    <span class="font-serif italic text-stone-400">Stillness</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="font-serif text-xl text-stone-800 block mb-2">In the silence, what became clear?</label>
                            <textarea oninput="saveEntry('cycle5', 'stillness', this.value)" class="w-full bg-transparent border-b border-stone-300 focus:border-stone-900 focus:outline-none min-h-[100px] journal-input resize-none text-stone-700 font-serif text-lg">${appState.entries.cycle5.stillness}</textarea>
                        </div>
                    </div>
                `
            },
            {
                id: 'cycle6',
                title: "Cycle 06: The Output",
                icon: "06",
                audioText: "Cycle 6. The Output. Insight without action is just entertainment. Look at the Commitment screen. Do not write a safe step. Commit to a bold step.",
                render: () => `
                    <div class="space-y-8">
                         <div class="flex justify-between items-end border-b border-stone-300 pb-4">
                            <div>
                                <h2 class="text-5xl font-serif italic text-stone-900">The Output</h2>
                                <span class="text-xs font-bold uppercase tracking-widest text-gold-600 mb-2">Cycle 06</span>
                            </div>
                            <button onclick="playSectionAudio()" class="p-3 bg-stone-100 rounded-full hover:bg-gold-400 transition-colors"><i data-lucide="headphones" class="w-5 h-5 text-stone-700"></i></button>
                        </div>
                        <div class="bg-gold-50 border border-gold-200 p-8 rounded-xl relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-20 text-6xl">‚ö°</div>
                            <label class="font-sans text-xs font-bold uppercase tracking-widest text-gold-800 block mb-4">The Contract</label>
                            <div class="space-y-6">
                                <div>
                                    <span class="font-serif text-2xl text-stone-800">I solemnly commit to</span>
                                    <input type="text" oninput="saveEntry('cycle6', 'action', this.value)" value="${appState.entries.cycle6.action}" class="bg-transparent border-b-2 border-stone-800 w-full font-serif text-2xl text-stone-900 focus:outline-none p-1" placeholder="take this action...">
                                </div>
                                <div>
                                    <span class="font-serif text-2xl text-stone-800">by</span>
                                    <input type="text" oninput="saveEntry('cycle6', 'commitment', this.value)" value="${appState.entries.cycle6.commitment}" class="bg-transparent border-b-2 border-stone-800 w-1/2 font-serif text-2xl text-stone-900 focus:outline-none p-1" placeholder="tomorrow at...">
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                id: 'cycle7',
                title: "Cycle 07: Pattern Rec",
                icon: "07",
                audioText: "Cycle 7. Pattern Recognition. Look at your data stream. Look at your new identity. You have shifted your baseline. Now, make it your lifestyle.",
                render: () => `
                    <div class="space-y-8">
                         <div class="flex justify-between items-end border-b border-stone-300 pb-4">
                            <div>
                                <h2 class="text-5xl font-serif italic text-stone-900">Pattern Rec</h2>
                                <span class="text-xs font-bold uppercase tracking-widest text-gold-600 mb-2">Cycle 07</span>
                            </div>
                            <button onclick="playSectionAudio()" class="p-3 bg-stone-100 rounded-full hover:bg-gold-400 transition-colors"><i data-lucide="headphones" class="w-5 h-5 text-stone-700"></i></button>
                        </div>
                        <div class="bg-stone-900 text-stone-50 p-8 rounded-2xl shadow-2xl relative overflow-hidden">
                            <div class="absolute -top-10 -right-10 w-40 h-40 bg-gold-500 rounded-full blur-[80px] opacity-20"></div>
                            <h3 class="font-sans text-xs font-bold uppercase tracking-widest text-gold-500 mb-6 relative z-10">Your Data Stream</h3>
                            <div class="space-y-4 font-serif text-lg text-stone-300 relative z-10">
                                <p><strong>Starting Stress (Avg):</strong> <span class="text-white">${appState.entries.cycle1.before}</span></p>
                                <p><strong>Primary Sensation:</strong> <span class="text-white">${appState.entries.cycle2.sensation || "Not logged"}</span></p>
                                <p><strong>Recurring Loop:</strong> <span class="text-white">${appState.entries.cycle3.thought || "Not logged"}</span></p>
                                <p><strong>Key Insight:</strong> <span class="text-white italic">"${appState.entries.cycle5.stillness || "..."}"</span></p>
                            </div>
                            <div class="mt-8 pt-8 border-t border-stone-800 relative z-10">
                                <p class="text-xs uppercase tracking-widest text-stone-500 mb-2">Your New Identity</p>
                                <textarea oninput="saveEntry('cycle7', 'identity', this.value)" class="w-full bg-transparent border-b border-stone-700 text-2xl font-serif italic text-white focus:outline-none h-20 resize-none" placeholder="I am the kind of person who...">${appState.entries.cycle7.identity}</textarea>
                            </div>
                        </div>
                    </div>
                `
            }
        ];

        // --- CORE LOGIC ---
        function init() {
            // Initialize Gate First
            initGate();
            
            // Load App Data
            loadData();
            renderNav();
            renderContent();
            renderMobileNav();
            updateProgress();
            
            // Gate Listeners
            document.getElementById('gate-pass').addEventListener('keypress', (e) => { 
                if(e.key === 'Enter') unlockGate();
            });
        }

        // --- AUDIO ENGINE (TTS) ---
        function speakText(text, ui) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.rate = 0.9; u.lang = 'en-US';
            u.onstart = () => { ui.status.innerText = "Speaking..."; ui.wave.classList.remove('hidden'); ui.icon.classList.add('hidden'); };
            u.onend = () => { ui.status.innerText = "Done"; ui.wave.classList.add('hidden'); ui.icon.classList.remove('hidden'); };
            window.speechSynthesis.speak(u);
        }
        
        function playSectionAudio() {
            const step = contentMap[appState.currentStep];
            if (!step || !step.audioText) return;
            const ui = { 
                bar: document.getElementById('audio-player-bar'), 
                status: document.getElementById('player-status'), 
                wave: document.getElementById('player-wave'), 
                icon: document.getElementById('player-icon') 
            };
            ui.bar.classList.remove('translate-y-[150%]');
            document.getElementById('player-title').innerText = "Coach's Guide";
            speakText(step.audioText, ui);
        }

        function stopAudio() { 
            window.speechSynthesis.cancel(); 
            document.getElementById('audio-player-bar').classList.add('translate-y-[150%]'); 
        }

        // --- STATE MANAGERS ---
        function loadData() {
            const saved = localStorage.getItem('adaptiv_journal_v2');
            if (saved) { try { appState.entries = { ...appState.entries, ...JSON.parse(saved) }; } catch(e) {} }
        }
        function saveEntry(cycle, key, value) {
            appState.entries[cycle][key] = value;
            localStorage.setItem('adaptiv_journal_v2', JSON.stringify(appState.entries));
            if (cycle === 'cycle1' && document.getElementById('c1Chart')) updateChart();
        }

        // --- RENDERERS ---
        function renderNav() {
            document.getElementById('desktop-nav').innerHTML = contentMap.map((item, i) => `
                <button onclick="goToStep(${i})" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-4 transition-all ${i === appState.currentStep ? 'bg-stone-800 text-white border-r-4 border-gold-500' : 'text-stone-500 hover:text-stone-300 hover:bg-stone-800/30'}">
                    <span class="font-mono text-xs opacity-50">${item.icon}</span>
                    <span class="font-serif text-lg italic">${item.title.split(':')[1] || item.title}</span>
                </button>
            `).join('');
        }
        
        function renderMobileNav() {
             const m = document.getElementById('mobile-menu');
             m.innerHTML = contentMap.map((item, i) => `
                <button onclick="goToStep(${i}); toggleMobileMenu()" class="text-xl font-serif italic ${i === appState.currentStep ? 'text-gold-400' : 'text-stone-300'}">
                    ${item.title}
                </button>
            `).join('');
        }

        function renderContent() {
            const container = document.getElementById('content-container');
            container.style.opacity = '0';
            setTimeout(() => {
                container.innerHTML = contentMap[appState.currentStep].render();
                container.style.opacity = '1';
                lucide.createIcons();
                if (appState.currentStep === 1) initChart();
            }, 300);
            
            document.getElementById('prev-btn').disabled = appState.currentStep === 0;
            document.getElementById('prev-btn').style.opacity = appState.currentStep === 0 ? '0' : '1';
            document.getElementById('next-btn').innerHTML = appState.currentStep === contentMap.length - 1 ? "Finish" : "Next &rarr;";
        }
        function goToStep(i) {
            if (i >= 0 && i < contentMap.length) {
                appState.currentStep = i;
                renderNav(); 
                renderContent(); 
                renderMobileNav(); 
                updateProgress();
            }
        }
        function updateProgress() {
            const pct = ((appState.currentStep + 1) / contentMap.length) * 100;
            document.getElementById('progress-bar').style.width = `${pct}%`;
        }
        function toggleMobileMenu() {
            const m = document.getElementById('mobile-menu');
            m.classList.toggle('hidden'); 
            m.classList.toggle('flex');
        }

        // --- CHART ---
        let chartInstance = null;
        function initChart() {
            const ctx = document.getElementById('c1Chart'); if(!ctx) return;
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: ['Entry', 'Exit'], datasets: [{ label: 'Stress Load', data: [appState.entries.cycle1.before, appState.entries.cycle1.after], backgroundColor: ['#44403c', '#f59e0b'], borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 10, display: false }, x: { grid: {display:false} } }, plugins: { legend: {display:false} } }
            });
        }
        function updateCycle1(val, type) {
            document.getElementById(`val-${type}`).innerText = val;
            saveEntry('cycle1', type, val);
        }
        function updateChart() {
            if(chartInstance) { chartInstance.data.datasets[0].data = [appState.entries.cycle1.before, appState.entries.cycle1.after]; chartInstance.update(); }
        }
        function toggleAccordion(btn) {
            const content = btn.nextElementSibling;
            const icon = btn.querySelector('span:last-child');
            if (content.style.maxHeight) { content.style.maxHeight = null; content.style.opacity = '0'; icon.style.transform = 'rotate(0deg)'; } 
            else { content.style.maxHeight = content.scrollHeight + "px"; content.style.opacity = '1'; icon.style.transform = 'rotate(180deg)'; }
        }

        document.getElementById('mobile-menu-btn').addEventListener('click', toggleMobileMenu);
        document.getElementById('prev-btn').addEventListener('click', () => goToStep(appState.currentStep - 1));
        document.getElementById('next-btn').addEventListener('click', () => goToStep(appState.currentStep + 1));

        init();
    </script>
</body>
</html>
